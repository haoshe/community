
#  Community Home Development Log

## Overview

Since the **controller depends on the service**, and the **service depends on the DAO**, we should start by developing the **DAO layer** first.

**Plan for today**:

* Implement the community homepage to display the first 10 posts.
* Add pagination so users can browse through all posts.

---

## 1. Develop DAO Layer

### 1.1 Entity — `DiscussPost`

`src/main/java/com/haoshe/community/entity/DiscussPost.java`

Each property corresponds to a column in the `discuss_post` table.
This is a partial implementation; getters, setters, and `toString` are omitted for brevity.

```java
package com.haoshe.community.entity;

import java.util.Date;

public class DiscussPost {

    private int id;
    private int userId;
    private String title;
    private String content;
    private int type;
    private int status;
    private Date createTime;
    private int commentCount;
    private double score;
    
    public int getId() {
        return id;
    }
}
```

---

### 1.2 Mapper Interface — `DiscussPostMapper`, define an interface named `DiscussPostMapper` that declares all the methods required to query the discuss_post table in the database.

`src/main/java/com/haoshe/community/dao/DiscussPostMapper.java`

```java
package com.haoshe.community.dao;

import com.haoshe.community.entity.DiscussPost;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.util.List;

@Mapper
public interface DiscussPostMapper {
    /*
     * Retrieves a list of discussion posts.
     *
     * Behavior:
     * - If userId == 0, all posts are returned (community homepage).
     * - If userId > 0, only posts created by the specified user are returned (personal homepage).
     *   This requires a dynamic SQL query based on the userId value.
     *
     * Pagination:
     * - offset: the starting row of the current page
     * - limit: the maximum number of posts to return per page
     */
    List<DiscussPost> selectDiscussPosts(int userId, int offset, int limit);

    /*
     * If userId == 0, number of all posts are returned (community homepage).
     * if userId > 0, only number of posts created by the specified user are returned (personal homepage).
     *
     * The @Param("userId") annotation is required because MyBatis uses it
     * to reference the parameter in the corresponding SQL statement.
     * Without @Param, MyBatis would not know how to map the method argument
     * to the placeholder in the SQL (especially when there is only one parameter).
     */
    int selectDiscussPostRows(@Param("userId") int userId);
}
```

---

### 1.3 Mapper XML — `discusspost-mapper.xml`, create a xml file called `discusspost-mapper.xml`, inside we implement methods defined in DiscussPostMapper interface.

`src/main/resources/mapper/discusspost-mapper.xml`

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.haoshe.community.dao.DiscussPostMapper">

    <sql id="selectFields">
        id, user_id, title, content, type, status, create_time, comment_count, score
    </sql>

    <select id="selectDiscussPosts" resultType = "DiscussPost">
        select <include refid="selectFields"></include>
        from discuss_post
        where status != 2
        <!-- If userId is not 0, filter results to only include posts created by that user -->
        <if test="userId != 0">
            and user_id = #{userId}
        </if>
        <!-- Order posts by type (e.g., pinned posts first), then by creation time (newest first) -->
        order by type desc, create_time desc
        <!-- Apply pagination: start from 'offset' and return at most 'limit' rows -->
        limit #{offset}, #{limit}
    </select>

    <select id="selectDiscussPostRows" resultType="int">
        <!--
            Use COUNT(id) to return the total number of posts.

            COUNT is a built-in SQL aggregate function.
            - COUNT(*)  → counts all rows (including those with NULLs).
            - COUNT(column) → counts only rows where the given column is NOT NULL.

            Since 'id' is a primary key (never NULL), COUNT(id) here is equivalent
            to COUNT(*). It ensures we are counting valid rows that meet the conditions.
        -->
        select count(id)
        from discuss_post
        <!-- 0-Normal; 1-Featured; 2-Blocked -->
        where status != 2
        <!-- If userId is not 0, filter results to only include posts created by that user -->
        <if test="userId != 0">
            and user_id = #{userId}
        </if>
    </select>
</mapper>
```

---

### 1.4 DAO Test — `MapperTests`

`src/test/java/com/haoshe/community/MapperTests.java`

```java
@Autowired
private DiscussPostMapper discussPostMapper;

@Test
public void testSelectPosts(){
    List<DiscussPost> list = discussPostMapper.selectDiscussPosts(149, 0, 10);
    for(DiscussPost post : list){
        System.out.println(post);
    }
    int rows = discussPostMapper.selectDiscussPostRows(149);
    System.out.println(rows);
}
```

---

## 2. Develop Service Layer

### 2.1 `DiscussPostService`

`src/main/java/com/haoshe/community/service/DiscussPostService.java`

```java
package com.haoshe.community.service;

import com.haoshe.community.dao.DiscussPostMapper;
import com.haoshe.community.entity.DiscussPost;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class DiscussPostService {

    @Autowired
    private DiscussPostMapper discussPostMapper;

    public List<DiscussPost> findDiscussPosts(int userId, int offset, int limit){
        return discussPostMapper.selectDiscussPosts(userId, offset, limit);
    }

    public int findDiscussPostRows(int userId){
        return discussPostMapper.selectDiscussPostRows(userId);
    }
}
```

---

### 2.2 `UserService`
Currently, the `findDiscussPosts` method returns a list of `DiscussPost` objects, but each post only contains a userId as a foreign key. Since the home page needs to display the `username` rather than just the `userId`, we should enhance the logic by retrieving the corresponding `User` for each `DiscussPost`. Then, we can combine the post data with the user information and pass the enriched result to the front end for rendering.  
Hence, I need to create an `UserService` class inside `src/main/java/com/haoshe/community/service/UserService.java`. In the class, I create `findUserById(int id)` method to retrieve `user` by its id.

`src/main/java/com/haoshe/community/service/UserService.java`

```java
@Service
public class UserService {

    @Autowired
    private UserMapper userMapper;

    public User findUserById(int id){
        return userMapper.selectById(id);
    }
}
```

---

## 3. Develop Display / Controller Layer

### 3.1 `HomeController`

`src/main/java/com/haoshe/community/controller/HomeController.java`

```java
// no need to specify path for controller
@Controller
public class HomeController {
    // Autowire the DiscussPostService and UserService to handle business logic.
    // Spring will automatically inject instances of these services.
    @Autowired
    private DiscussPostService discussPostService;

    @Autowired
    private UserService userService;

    /**
     * Handles GET requests to the home page ("/index").
     * This method retrieves a list of discussion posts, enriches each post with its
     * corresponding user information, and adds the combined data to the model for
     * rendering on the front end.
     * * @param model A Spring Model object to store data that will be passed to the view.
     * @return The logical view name "index", which Spring resolves to the
     * src/main/resources/templates/index.html template.
     */
    @RequestMapping(path = "/index", method = RequestMethod.GET)
    public String getIndexPage(Model model){
        // Retrieve a paginated list of discussion posts.
        // The parameters (0, 0, 10) represent the current page, offset, and page size.
        List<DiscussPost> list = discussPostService.findDiscussPosts(0, 0, 10);

        // Create a list to store a combination of post and user data.
        List<Map<String, Object>> discussPosts = new ArrayList<>();

        if(list != null){
            for(DiscussPost post : list){
                Map<String, Object> map = new HashMap<>();
                map.put("post", post);
                User user = userService.findUserById(post.getUserId());
                map.put("user", user);
                discussPosts.add(map);
            }
        }
        
        // Add the enriched list of posts to the model, making it accessible in the template.
        model.addAttribute("discussPosts", discussPosts);
        return "/index"; // src/main/resources/templates/index.html
    }
}
```

---

### 3.2 `index.html` (Thymeleaf)

Make sure to add `th:` attributes for Thymeleaf processing:

```html
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<link rel="stylesheet" th:href="@{/css/global.css}" />

<script th:src="@{/js/global.js}"></script>

<script th:src="@{js/index.js}"></script>
```

Dynamic display example:

```html
<!-- 帖子列表 -->
<ul class="list-unstyled">
    <li class="media pb-3 pt-3 mb-3 border-bottom" th:each="map:${discussPosts}">
        <a href="site/profile.html">
            <img th:src="${map.user.headerUrl}" class="mr-4 rounded-circle" alt="用户头像" style="width:50px;height:50px;">
        </a>
        <div class="media-body">
            <h6 class="mt-0 mb-3">
                <a href="#" th:utext="${map.post.title}">备战春招，面试刷题跟他复习，一个月全搞定！</a>
                <span class="badge badge-secondary bg-primary" th:if="${map.post.type==1}">置顶</span>
                <span class="badge badge-secondary bg-danger" th:if="${map.post.status==1}">精华</span>
            </h6>
            <div class="text-muted font-size-12">
                <u class="mr-3" th:utext="${map.user.username}">寒江雪</u> 发布于 <b th:text="${#dates.format(map.post.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15 15:32:18</b>
                <ul class="d-inline float-right">
                    <li class="d-inline ml-2">赞 11</li>
                    <li class="d-inline ml-2">|</li>
                    <li class="d-inline ml-2">回帖 7</li>
                </ul>
            </div>
        </div>						
    </li>
</ul>
```

---

## 4. Pagination

### 4.1 `Page` Class

`src/main/java/com/haoshe/community/entity/Page.java`

Encapsulates pagination-related information.

---

### 4.2 Update `HomeController`

`src/main/java/com/haoshe/community/controller/HomeController.java`

```java
// No need to specify the path for the controller, as it is a root controller.
@Controller
public class HomeController {
    // Autowire the DiscussPostService and UserService to handle business logic.
    // Spring will automatically inject instances of these services.
    @Autowired
    private DiscussPostService discussPostService;

    @Autowired
    private UserService userService;

    /**
     * Handles GET requests to the home page ("/index").
     * This method retrieves a list of discussion posts, enriches each post with its
     * corresponding user information, and adds the combined data to the model for
     * rendering on the front end.
     *
     * @param model A Spring Model object to store data that will be passed to the view.
     * @param page  An instance of the Page object, automatically created and injected by Spring MVC
     * from the request parameters (e.g., ?current=2).
     * @return The logical view name "index", which Spring resolves to the
     * src/main/resources/templates/index.html template.
     */
    @RequestMapping(path = "/index", method = RequestMethod.GET)
    public String getIndexPage(Model model, Page page){
        // Spring MVC automatically creates and populates the 'page' object based on
        // request parameters (e.g., ?current=2), and then injects it into the Model.
        // This makes the 'page' object and its properties directly accessible in the Thymeleaf template.

        // Count the total number of rows (posts) to calculate the total number of pages.
        // The userId is 0 here, which means we are counting all posts.
        page.setRows(discussPostService.findDiscussPostRows(0));

        // Set the path for the pagination links, allowing for reusable pagination links on the page.
        page.setPath("/index");

        // Retrieve a paginated list of discussion posts from the service layer.
        // The parameters are the userId (0 for all users), the offset (starting row), and the limit (page size).
        List<DiscussPost> list = discussPostService.findDiscussPosts(0, page.getOffset(), page.getLimit());

        // Create a list to store a combination of post and user data.
        List<Map<String, Object>> discussPosts = new ArrayList<>();

        if(list != null){
            for(DiscussPost post : list){
                Map<String, Object> map = new HashMap<>();
                map.put("post", post);
                User user = userService.findUserById(post.getUserId());
                map.put("user", user);
                discussPosts.add(map);
            }
        }

        // Add the enriched list of posts to the model, making it accessible in the template.
        model.addAttribute("discussPosts", discussPosts);
        // Return the logical view name "index", which the view resolver will map to the template file.
        return "/index";
    }
}
```

---

### 4.3 Pagination in `index.html`

```html
<!-- 分页 -->
<nav class="mt-5" th:if="${page.rows>0}">
    <ul class="pagination justify-content-center">
        <li class="page-item">
            <a class="page-link" th:href="@{${page.path}(current=1)}">首页</a>
        </li>
        <li th:class="|page-item ${page.current==1?'disabled':''}|">
            <a class="page-link" th:href="@{${page.path}(current=${page.current-1})}">上一页</a>
        </li>
        <li th:class="|page-item ${i==page.current?'active':''}|" th:each="i:${#numbers.sequence(page.from,page.to)}">
            <a class="page-link" href="#" th:text="${i}">1</a>
        </li>
        <li th:class="|page-item ${page.current==page.total?'disabled':''}|">
            <a class="page-link" th:href="@{${page.path}(current=${page.current+1})}">下一页</a>
        </li>
        <li class="page-item">
            <a class="page-link" th:href="@{${page.path}(current=${page.total})}">末页</a>
        </li>
    </ul>
</nav>
```


