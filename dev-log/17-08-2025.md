# Spring Boot Email Setup Guide

This guide walks you through setting up email functionality in a Spring Boot application using JavaMailSender and Thymeleaf templates.

## 1. Email Configuration Setup

### Activate Client-Side SMTP Service

First, you need to configure third-party access to your email provider (like Gmail).

ðŸ“– **Reference:** [Baeldung Spring Email Guide](https://www.baeldung.com/spring-email) shows you how to set up third-party access to Google email.

## 2. Spring Email Dependencies

### Add Maven Dependency

Add the Spring Boot Mail Starter dependency to your `community/pom.xml` file:

**Maven Repository:** [Spring Boot Starter Mail](https://mvnrepository.com/search?q=Spring+boot+mail+starter)

```xml
<!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-mail -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-mail</artifactId>
    <version>3.5.4</version>
</dependency>
```

### Configure Email Properties

Add the following properties to `src/main/resources/application.properties`:

```properties
spring.mail.host=${SPRING_MAIL_HOST}
spring.mail.port=${SPRING_MAIL_PORT}
spring.mail.username=${SPRING_MAIL_USERNAME}
spring.mail.password=${SPRING_MAIL_PASSWORD}
spring.mail.properties.mail.smtp.auth=true
spring.mail.properties.mail.smtp.starttls.enable=true
```

## 3. Email Service Implementation

### Create Mail Client Utility

The `MailClient` is a utility class that simplifies email sending in your Spring Boot application. It acts as a wrapper around Spring's `JavaMailSender` to provide a clean, easy-to-use interface for sending emails.

**What MailClient does:**
- Encapsulates email sending logic
- Handles MIME message creation and configuration
- Provides error handling and logging
- Supports both plain text and HTML email content

**How to use MailClient:**
- Inject it into any Spring component using `@Autowired`
- Call `sendMail(to, subject, content)` method
- For HTML emails, pass HTML content as the content parameter
- For plain text emails, pass plain text as the content parameter

Create a utility directory `com/haoshe/community/util` and add the `MailClient` class:

```java
/**
 * Mail utility class for sending emails through SMTP
 * Provides a simple interface for sending both plain text and HTML emails
 */
@Component
public class MailClient {

    private static final Logger logger = LoggerFactory.getLogger(MailClient.class);

    // Spring's email sender - automatically configured from application.properties
    @Autowired
    private JavaMailSender mailSender;

    // Email address to send from - loaded from application.properties
    @Value("${spring.mail.username}")
    private String from;

    /**
     * Send an email to a recipient
     * 
     * @param to      recipient email address
     * @param subject email subject line
     * @param content email content (can be plain text or HTML)
     */
    public void sendMail(String to, String subject, String content) {
        try {
            // Create a new MIME message
            MimeMessage message = mailSender.createMimeMessage();
            // Helper to easily configure the message
            MimeMessageHelper helper = new MimeMessageHelper(message);
            
            // Set email headers
            helper.setFrom(from);           // From address
            helper.setTo(to);               // To address
            helper.setSubject(subject);     // Subject line
            
            // Set content - 'true' parameter enables HTML content
            helper.setText(content, true);
            
            // Send the email
            mailSender.send(helper.getMimeMessage());
            
            logger.info("Email sent successfully to: {}", to);
            
        } catch (MessagingException e) {
            // Log error if email sending fails
            logger.error("Failed to send email to {}: {}", to, e.getMessage());
        }
    }
}
```

### Create Email Tests

Set up a test class at `src/test/java/com/haoshe/community/MailTests.java`:

```java
@RunWith(SpringRunner.class)
@SpringBootTest
@ContextConfiguration(classes = CommunityApplication.class)
public class MailTests {

    @Autowired
    private MailClient mailClient;

    @Autowired
    private TemplateEngine templateEngine;

    @Test
    public void testTextMail() {
        mailClient.sendMail("haoshecn@hotmail.com", "test", "Welcome");
    }

    @Test
    public void testHtmlMail() {
        Context context = new Context();
        context.setVariable("username", "Kevin");
        String content = templateEngine.process("demo/mail/demo", context);
        System.out.println(content);
        mailClient.sendMail("haoshecn@hotmail.com", "Html", content);
    }
}
```

## 4. HTML Email Templates with Thymeleaf

### Create HTML Email Template

Use Thymeleaf to send styled HTML emails. Create a template file at `templates/demo/mail/demo.html`:

```html
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Mail Example</title>
</head>
<body>
    <p>Welcome, <span style="color:red;" th:text="${username}"></span>!</p>
</body>
</html>
```

## Key Features

- âœ… **SMTP Authentication**: Secure email sending with authentication
- âœ… **HTML Support**: Send rich HTML emails with styling
- âœ… **Template Engine**: Use Thymeleaf for dynamic content
- âœ… **Environment Variables**: Secure configuration using environment variables
- âœ… **Error Handling**: Proper exception handling and logging

